(function(b){b.widget("mobile.lazyloader",b.mobile.widget,{$element:null,$page:null,$ul:null,_defaultOptions:{threshold:360,retrieve:20,retrieved:20,bubbles:!1,offset:0},_defaultParameters:{retrieve:20,retrieved:20,offset:0},_defaultSettings:{pageId:"",ulId:"",progressDivId:"",moreUrl:"",clearUrl:""},_handleScrollStartJustFired:!1,_handleScrollStopJustFired:!1,_mouseWheelEventJustFired:!1,_handleScrollStartTimeoutId:null,_handleScrollStopTimeoutId:null,_mouseWheelTimeoutId:null,_instances:{},parameters:null,
_settings:null,timeoutOptions:{mousewheel:400,scrollstart:600,scrollstop:60,showprogress:200,scrolldown:400,immediately:0},_widgetName:"lazyloader",_widgetState:{busy:!1,done:!1},_create:function(){this._initialize(this._defaultOptions,this._defaultSettings,this._defaultParameters);this._bind()},_init:function(){},_initialize:function(a,c,d){"undefined"!=typeof a&&""!=a&&(this._widgetState.busy=!1,this._widgetState.done=!1,this._settings=b.extend(!0,this._defaultSettings,c),this.parameters=b.extend(!0,
this._defaultParameters,d),a=JSON.stringify(b.extend(!0,this._defaultOptions,a)),c=c.pageId,"undefined "!=typeof c&&""!=c?(this._instances[c]||(this._instances[c]=b.parseJSON(a)),this.options=b.extend(!0,this._defaultOptions,this._instances[c])):this.options=b.parseJSON(a),this.$element=this.element,this.$page=this.$element.parents(":jqmData(role='page')"),this.$ul=b(":jqmData(role='listview')"))},_bind:function(){b("body").bind("scrollstart",b.proxy(this._handleScrollStart,this));b("body").bind("scrollstop",
b.proxy(this._handleScrollStop,this));/Firefox/i.test(navigator.userAgent)?b(window).bind("DOMMouseScroll",b.proxy(this._handleMouseWheelEvent,this)):b("#"+this._settings.ulId).attachEvent?b(window).bind("onmousewheel",b.proxy(this._handleMouseWheelEvent,this)):b(window).bind("mousewheel",b.proxy(this._handleMouseWheelEvent,this))},_unbind:function(){b("body").unbind("scrollstart",this._handleScrollStart);b("body").unbind("scrollstop",this._handleScrollStop);/Firefox/i.test(navigator.userAgent)?b(window).unbind("DOMMouseScroll",
this._handleMouseWheelEvent):b("#"+this._settings.ulId).attachEvent?b(window).unbind("onmousewheel",this._handleMouseWheelEvent):b(window).unbind("mousewheel",this._handleMouseWheelEvent)},destroy:function(){this._unbind();this.timeoutOptions=this._defaultParameters=this._defaultSettings=this._defaultOptions=this._widgetState=this._mouseWheelTimeoutId=this._handleScrollStopTimeoutId=this._handleScrollStartTimeoutId=this._mouseWheelEventJustFired=this._handleScrollStopJustFired=this._handleScrollStartJustFired=
this._instances=this.parameters=this.options=this._settings=this.$ul=this.$page=this.$element=null;b.Widget.prototype.destroy.apply(this)},_check:function(a){var a=this.options.threshold||a,c,d,e;d=document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop;c=b("#"+this._settings.pageId).height();e=b(window).height();return c-a<=d+e},_load:function(a){!this._widgetState.busy&&!this._widgetState.done&&($that=this,setTimeout(function(){$that._check($that.options.threshold)&&
b("#"+$that._settings.progressDivId).show($that.timeoutOptions.showprogress,function(){$that._instances[$that._settings.pageId]?($that.parameters.retrieve=$that._instances[$that._settings.pageId].retrieve,$that.parameters.retrieved=$that._instances[$that._settings.pageId].retrieved,$that.parameters.offset=$that._instances[$that._settings.pageId].offset):($that.parameters.retrieve=$that.options.retrieve,$that.parameters.retrieved=$that.options.retrieved,$that.parameters.offset=$that.options.offset);
if("undefined"!=typeof $that._settings.pageId&&""!=$that._settings.pageId){var a=b("#"+$that._settings.pageId).find('[type="hidden"]');for(i=0;i<a.length;i++){var d=b(a).get(i);"undefined"!=typeof b(d).attr("id")&&""!=b(d).attr("id")&&($that.parameters[b(d).attr("id")]=escape(b(d).val()))}}var a="",e=0,f;for(f in $that.parameters)a=0==e?a+(f+"="+$that.parameters[f]):a+("&"+f+"="+$that.parameters[f]),e+=1;console.log($that._settings.url);console.log(a);b.ajax({type:"POST",url:$that._settings.moreUrl,
async:!0,data:a,success:function(a){more=b.parseJSON(a);e=more.data[0].count;html=more.data[0].html;if(e>0){b("#"+$that._settings.ulId+" li").last().before(html);b("#"+$that._settings.ulId).listview("refresh");$that._instances[$that._settings.pageId].retrieved=$that._instances[$that._settings.pageId].retrieved+parseInt(e);if(e<$that.options.retrieve){$that._widgetState.done=true;$that._trigger("doneloading",{type:"lazyloaderdone","function":"_load",pageId:$that._settings.pageId,ulId:$that._settings.ulId,
loaded:$that.options.retrieved})}}else{$that._widgetState.done=true;$that._trigger("doneloading",{type:"lazyloaderdone","function":"_load",pageId:$that._settings.pageId,ulId:$that._settings.ulId,loaded:$that.options.retrieved})}b("#"+$that._settings.progressDivId).hide(250,function(){$that._widgetState.busy=false})},error:function(a){$that._trigger("error",{type:"lazyloadererror","function":"_load",message:a,settings:$that._settings,options:$that.options,parameters:$that.parameters});b("#"+$that._settings.progressDivId).hide(250,
function(){$that._widgetState.busy=false})}})})},a))},_handleMouseWheelEvent:function(){if(!this._mouseWheelEventJustFired&&!this._handleScrollStopJustFired&&!this._handleScrollStartJustFired){this._mouseWheelEventJustFired=!0;this._load(this.timeoutOptions.mousewheel);var a=this;this._mouseWheelTimeoutId=setTimeout(function(){a._mouseWheelEventJustFired=!1},1E3)}},_handleScrollStart:function(){if(!this._mouseWheelEventJustFired&&!this._handleScrollStopJustFired&&!this._handleScrollStartJustFired){this._handleScrollStartJustFired=
!0;this._load(this.timeoutOptions.scrollstart);var a=this;this._handleScrollStartTimeoutId=setTimeout(function(){a._handleScrollStartJustFired=!1},1200)}},_handleScrollStop:function(){if(!this._mouseWheelEventJustFired&&!this._handleScrollStopJustFired&&!this._handleScrollStartJustFired){this._handleScrollStopJustFired=!0;this._load(this.timeoutOptions.scrollstop);var a=this;this._handleScrollStopTimeoutId=setTimeout(function(){a._handleScrollStopJustFired=!1},1200)}},loadMore:function(a){0===a?this._load(this.timeoutOptions.immediately):
this._load(this.timeoutOptions.scrolldown)},refresh:function(a,b){if("parameters"==a){if("undefined"!=typeof this.options)for(var d in this.parameters)"undefined"!=typeof this.options[d]&&(this.parameters[d]=this.options[d])}else"parameter"==a&&(d=b,"undefined"!=typeof this.options[d]&&(this.parameters[d]=this.options[d]))},reInitialize:function(a,b,d){this._initialize(a,b,d)},reset:function(a){var c=this;b.ajax({type:"POST",url:c._settings.clearUrl,async:!0,data:"section="+a,success:function(b){parseInt(b)&&
(c.options.retrieved=c._defaultOptions.retrieved,c._widgetState.done=!1,"undefined"!=typeof c._instances[a]&&delete c._instances[a],c._trigger("reset",{type:"lazyloaderreset","function":"reset",pageId:a,settings:c._settings,options:c.options,parameters:c.parameters}))},error:function(a){c._trigger("error",{type:"lazyloadererror","function":"reset",message:a,settings:c._settings,options:c.options,parameters:c.parameters});b("#"+c._settings.progressDivId).hide(250,function(){c._widgetState.busy=!1})}})},
resetAll:function(){var a=this;b.ajax({type:"POST",url:a._settings.clearUrl,async:!0,data:"",success:function(b){if(parseInt(b)){for(pageId in a._instances)a._instances[pageId]&&delete a._instances[pageId];a.options.retrieved=a._defaultOptions.retrieved;a._widgetState.done=!1;a._widgetState.busy=!1;a._trigger("resetall",{type:"lazyloaderresetall","function":"resetAll",_widgetState:a._widgetState,_instances:a._instances})}}})}});b(document).bind("pagecreate create",function(a){b.mobile.lazyloader.prototype.enhanceWithin(a.target)})})(jQuery);
