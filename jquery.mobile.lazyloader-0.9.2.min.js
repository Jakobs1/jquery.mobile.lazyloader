(function(b){b.widget("mobile.lazyloader",b.mobile.widget,{$element:null,$page:null,$ul:null,_defaultOptions:{threshold:360,retrieve:20,retrieved:20,bubbles:!1,offset:0,transform:""},_defaultParameters:{retrieve:20,retrieved:20,offset:0},_defaultSettings:{pageId:"",ulId:"",progressDivId:"",moreUrl:"",clearUrl:""},_handleScrollStartJustFired:!1,_handleScrollStopJustFired:!1,_mouseWheelEventJustFired:!1,_handleScrollStartTimeoutId:null,_handleScrollStopTimeoutId:null,_mouseWheelTimeoutId:null,_instances:{},
parameters:null,_settings:null,timeoutOptions:{mousewheel:400,scrollstart:600,scrollstop:60,showprogress:200,scrolldown:400,immediately:0},_widgetName:"lazyloader",_widgetState:{busy:!1,done:!1},_create:function(){this._initialize(this._defaultOptions,this._defaultSettings,this._defaultParameters);this._bind()},_init:function(){},_initialize:function(a,d,c){"undefined"!=typeof a&&""!=a&&(this._widgetState.busy=!1,this._widgetState.done=!1,this._settings=b.extend(!0,this._settings,this._defaultSettings),
this._settings=b.extend(!0,this._settings,d),this.parameters=b.extend(!0,this.parameters,this._defaultParameters),this.parameters=b.extend(!0,this.parameters,c),this.options=b.extend(!0,this.options,this._defaultOptions),this.options=b.extend(!0,this.options,a),a=d.pageId,"undefined "!=typeof a&&""!=a&&!this._instances[a]&&(optionsAsString=JSON.stringify(this.options),this._instances[a]=b.parseJSON(optionsAsString)),this.$element=this.element,this.$page=this.$element.parents(":jqmData(role='page')"),
this.$ul=b(":jqmData(role='listview')"))},_bind:function(){b("body").bind("scrollstart",b.proxy(this._handleScrollStart,this));b("body").bind("scrollstop",b.proxy(this._handleScrollStop,this));/Firefox/i.test(navigator.userAgent)?b(window).bind("DOMMouseScroll",b.proxy(this._handleMouseWheelEvent,this)):b("#"+this._settings.ulId).attachEvent?b(window).bind("onmousewheel",b.proxy(this._handleMouseWheelEvent,this)):b(window).bind("mousewheel",b.proxy(this._handleMouseWheelEvent,this))},_unbind:function(){b("body").unbind("scrollstart",
this._handleScrollStart);b("body").unbind("scrollstop",this._handleScrollStop);/Firefox/i.test(navigator.userAgent)?b(window).unbind("DOMMouseScroll",this._handleMouseWheelEvent):b("#"+this._settings.ulId).attachEvent?b(window).unbind("onmousewheel",this._handleMouseWheelEvent):b(window).unbind("mousewheel",this._handleMouseWheelEvent)},destroy:function(){this._unbind();this.timeoutOptions=this._defaultParameters=this._defaultSettings=this._defaultOptions=this._widgetState=this._mouseWheelTimeoutId=
this._handleScrollStopTimeoutId=this._handleScrollStartTimeoutId=this._mouseWheelEventJustFired=this._handleScrollStopJustFired=this._handleScrollStartJustFired=this._instances=this.parameters=this.options=this._settings=this.$ul=this.$page=this.$element=null;b.Widget.prototype.destroy.apply(this)},_check:function(a){var a=this.options.threshold||a,d,c,e;c=document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop;d=b("#"+this._settings.pageId).height();e=b(window).height();
return d-a<=c+e},_load:function(a){!this._widgetState.busy&&!this._widgetState.done&&($that=this,setTimeout(function(){($that._check($that.options.threshold)||0===a)&&b("#"+$that._settings.progressDivId).show($that.timeoutOptions.showprogress,function(){$that._instances[$that._settings.pageId]?($that.parameters.retrieve=$that._instances[$that._settings.pageId].retrieve,$that.parameters.retrieved=$that._instances[$that._settings.pageId].retrieved,$that.parameters.offset=$that._instances[$that._settings.pageId].offset):
($that.parameters.retrieve=$that.options.retrieve,$that.parameters.retrieved=$that.options.retrieved,$that.parameters.offset=$that.options.offset);if("undefined"!=typeof $that._settings.pageId&&""!=$that._settings.pageId){var a=b("#"+$that._settings.pageId).find('[type="hidden"]');for(i=0;i<a.length;i++){var c=b(a).get(i);"undefined"!=typeof b(c).attr("id")&&""!=b(c).attr("id")&&($that.parameters[b(c).attr("id")]=escape(b(c).val()))}}var a="",c=0,e;for(e in $that.parameters)a=0==c?a+(e+"="+$that.parameters[e]):
a+("&"+e+"="+$that.parameters[e]),c+=1;b.ajax({type:"POST",url:$that._settings.moreUrl,async:!0,data:a,success:function(a){var a=b.parseJSON(a),c=a.data[0].count,d="",e=d="",g="",f="";if(c>0){e="#"+$that._settings.ulId;g="#"+$that._settings.ulId+" li";f=$that._getBottomElement(e,'[data-role="list-divider"]');if(typeof a.data[0].html!="undefined"&&a.data[0].html!=""){d=a.data[0].html;f?b(g).last().before(d):b(e).append(d)}else{d=a.data[0].json;if(typeof d!="undefined"&&d!=""){f&&f.remove();b(e).json2html(d,
$that._instances[$that._settings.pageId].transform);f&&b(g).last().append(f)}}b(e).listview("refresh");$that._instances[$that._settings.pageId].retrieved=$that._instances[$that._settings.pageId].retrieved+parseInt(c);if(c<$that.options.retrieve||$that.options.retrieve=="all"){$that._widgetState.done=true;$that._trigger("alldone",{type:"lazyloaderalldone","function":"_load",pageId:$that._settings.pageId,ulId:$that._settings.ulId,loaded:$that.options.retrieved})}}else{$that._widgetState.done=true;$that._trigger("alldone",
{type:"lazyloaderalldone","function":"_load",pageId:$that._settings.pageId,ulId:$that._settings.ulId,loaded:$that.options.retrieved})}b("#"+$that._settings.progressDivId).hide(250,function(){$that._widgetState.busy=false});$that._trigger("doneloading",{type:"lazyloaderdoneloading","function":"_load",pageId:$that._settings.pageId,ulId:$that._settings.ulId,loaded:$that.options.retrieved})},error:function(a){$that._trigger("error",{type:"lazyloadererror","function":"_load",message:a,settings:$that._settings,
options:$that.options,parameters:$that.parameters});b("#"+$that._settings.progressDivId).hide(250,function(){$that._widgetState.busy=false})}})})},a))},_getBottomElement:function(a,d){var c=b(a).find(d);switch(c.length){case 2:c=c.last();break;default:c=null}return"undefined"!=typeof c&&null!=c&&""!=c&&"null"!=c?c:!1},_handleMouseWheelEvent:function(){if(!this._mouseWheelEventJustFired&&!this._handleScrollStopJustFired&&!this._handleScrollStartJustFired){this._mouseWheelEventJustFired=!0;this._load(this.timeoutOptions.mousewheel);
var a=this;this._mouseWheelTimeoutId=setTimeout(function(){a._mouseWheelEventJustFired=!1},1E3)}},_handleScrollStart:function(){if(!this._mouseWheelEventJustFired&&!this._handleScrollStopJustFired&&!this._handleScrollStartJustFired){this._handleScrollStartJustFired=!0;this._load(this.timeoutOptions.scrollstart);var a=this;this._handleScrollStartTimeoutId=setTimeout(function(){a._handleScrollStartJustFired=!1},1200)}},_handleScrollStop:function(){if(!this._mouseWheelEventJustFired&&!this._handleScrollStopJustFired&&
!this._handleScrollStartJustFired){this._handleScrollStopJustFired=!0;this._load(this.timeoutOptions.scrollstop);var a=this;this._handleScrollStopTimeoutId=setTimeout(function(){a._handleScrollStopJustFired=!1},1200)}},loadMore:function(a){0===a?this._load(this.timeoutOptions.immediately):this._load(this.timeoutOptions.scrolldown)},_setOption:function(a,d){this._instances[this._settings.pageId]&&this._instances[this._settings.pageId][a]&&(this._instances[this._settings.pageId][a]=d);b.Widget.prototype._setOption.apply(this,
arguments)},refresh:function(a,d){if("parameters"==a){if("undefined"!=typeof this.options)for(var c in this.parameters)"undefined"!=typeof this.options[c]&&(this.parameters[c]=this.options[c])}else"parameter"==a&&(c=d,"undefined"!=typeof this.options[c]&&(this.parameters[c]=this.options[c]));c=JSON.stringify(this.parameters);this.parameters=b.parseJSON(c)},reInitialize:function(a,b,c){this._initialize(a,b,c)},reset:function(a){var d=this;b.ajax({type:"POST",url:d._settings.clearUrl,async:!0,data:"section="+
a,success:function(b){parseInt(b)&&(d.options.retrieved=d._defaultOptions.retrieved,d._widgetState.done=!1,"undefined"!=typeof d._instances[a]&&delete d._instances[a],d._trigger("reset",{type:"lazyloaderreset","function":"reset",pageId:a,settings:d._settings,options:d.options,parameters:d.parameters}))},error:function(a){d._trigger("error",{type:"lazyloadererror","function":"reset",message:a,settings:d._settings,options:d.options,parameters:d.parameters});b("#"+d._settings.progressDivId).hide(250,
function(){d._widgetState.busy=!1})}})},resetAll:function(){var a=this;b.ajax({type:"POST",url:a._settings.clearUrl,async:!0,data:"",success:function(b){if(parseInt(b)){for(pageId in a._instances)a._instances[pageId]&&delete a._instances[pageId];a.options.retrieved=a._defaultOptions.retrieved;a._widgetState.done=!1;a._widgetState.busy=!1;a._trigger("resetall",{type:"lazyloaderresetall","function":"resetAll",_widgetState:a._widgetState,_instances:a._instances})}}})}});b(document).bind("pagecreate create",
function(a){b.mobile.lazyloader.prototype.enhanceWithin(a.target)})})(jQuery);
