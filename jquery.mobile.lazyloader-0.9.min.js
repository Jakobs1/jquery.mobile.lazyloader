(function(a){a.widget("mobile.lazyloader",a.mobile.widget,{$element:null,$page:null,$ul:null,_defaultOptions:{threshold:360,retrieve:20,retrieved:20,bubbles:!1,offset:0},_defaultParameters:{retrieve:20,retrieved:20,offset:0},_defaultSettings:{pageId:"",ulId:"",progressDivId:"",moreUrl:"",clearUrl:""},_handleScrollStartJustFired:!1,_handleScrollStopJustFired:!1,_mouseWheelEventJustFired:!1,_handleScrollStartTimeoutId:null,_handleScrollStopTimeoutId:null,_mouseWheelTimeoutId:null,_instances:{},_options:null,
_parameters:null,_settings:null,timeoutOptions:{mousewheel:400,scrollstart:600,scrollstop:60,showprogress:200},_widgetName:"lazyloader",_widgetState:{busy:!1,done:!1},_create:function(){this._initialize(this._defaultOptions,this._defaultSettings,this._defaultParameters);this._bind()},_init:function(){},_initialize:function(b,c,e){"undefined"!=typeof b&&""!=b&&(this._widgetState.busy=!1,this._widgetState.done=!1,this._settings=a.extend(!0,this._defaultSettings,c),this._parameters=a.extend(!0,this._defaultParameters,
e),b=JSON.stringify(a.extend(!0,this._defaultOptions,b)),c=c.pageId,"undefined "!=typeof c&&""!=c?(this._instances[c]||(this._instances[c]=a.parseJSON(b)),this._options=a.extend(!0,this._defaultOptions,this._instances[c])):this._options=a.parseJSON(b),this.$element=this.element,this.$page=this.$element.parents(":jqmData(role='page')"),this.$ul=a(":jqmData(role='listview')"))},_bind:function(){a("body").bind("scrollstart",a.proxy(this._handleScrollStart,this));a("body").bind("scrollstop",a.proxy(this._handleScrollStop,
this));/Firefox/i.test(navigator.userAgent)?a(window).bind("DOMMouseScroll",a.proxy(this._handleMouseWheelEvent,this)):a("#"+this._settings.ulId).attachEvent?a(window).bind("onmousewheel",a.proxy(this._handleMouseWheelEvent,this)):a(window).bind("mousewheel",a.proxy(this._handleMouseWheelEvent,this))},_unbind:function(){a("body").unbind("scrollstart",this._handleScrollStart);a("body").unbind("scrollstop",this._handleScrollStop);/Firefox/i.test(navigator.userAgent)?a(window).unbind("DOMMouseScroll",
this._handleMouseWheelEvent):a("#"+this._settings.ulId).attachEvent?a(window).unbind("onmousewheel",this._handleMouseWheelEvent):a(window).unbind("mousewheel",this._handleMouseWheelEvent)},destroy:function(){this._unbind();this.timeoutOptions=this._defaultParameters=this._defaultSettings=this._defaultOptions=this._widgetState=this._mouseWheelTimeoutId=this._handleScrollStopTimeoutId=this._handleScrollStartTimeoutId=this._mouseWheelEventJustFired=this._handleScrollStopJustFired=this._handleScrollStartJustFired=
this._instances=this._parameters=this._options=this._settings=this.$ul=this.$page=this.$element=null;a.Widget.prototype.destroy.apply(this)},_check:function(b){var b=this._options.threshold||b,c,e,d;e=document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop;c=a("#"+this._settings.pageId).height();d=a(window).height();return c-b<=e+d},_load:function(b){!this._widgetState.busy&&!this._widgetState.done&&($that=this,setTimeout(function(){$that._check($that._options.threshold)&&
a("#"+$that._settings.progressDivId).show($that.timeoutOptions.showprogress,function(){$that._instances[$that._settings.pageId]?($that._parameters.retrieve=$that._instances[$that._settings.pageId].retrieve,$that._parameters.retrieved=$that._instances[$that._settings.pageId].retrieved,$that._parameters.offset=$that._instances[$that._settings.pageId].offset):($that._parameters.retrieve=$that._options.retrieve,$that._parameters.retrieved=$that._options.retrieved,$that._parameters.offset=$that._options.offset);
if("undefined"!=typeof $that._settings.pageId&&""!=$that._settings.pageId){var c=a("#"+$that._settings.pageId).find('[type="hidden"]');for(i=0;i<c.length;i++){var b=a(c).get(i);"undefined"!=typeof a(b).attr("id")&&""!=a(b).attr("id")&&($that._parameters[a(b).attr("id")]=escape(a(b).val()))}}var c="",d=0,f;for(f in $that._parameters)c=0==d?c+(f+"="+$that._parameters[f]):c+("&"+f+"="+$that._parameters[f]),d+=1;console.log($that._settings.url);console.log(c);a.ajax({type:"POST",url:$that._settings.moreUrl,
async:!0,data:c,success:function(b){more=a.parseJSON(b);d=more.data[0].count;html=more.data[0].html;if(d>0){a("#"+$that._settings.ulId+" li").last().before(html);a("#"+$that._settings.ulId).listview("refresh");$that._instances[$that._settings.pageId].retrieved=$that._instances[$that._settings.pageId].retrieved+parseInt(d);if(d<$that._options.retrieve){$that._widgetState.done=true;$that._trigger("doneloading",{type:"lazyloaderdone","function":"_load",pageId:$that._settings.pageId,ulId:$that._settings.ulId,
loaded:$that._options.retrieved})}}else{$that._widgetState.done=true;$that._trigger("doneloading",{type:"lazyloaderdone","function":"_load",pageId:$that._settings.pageId,ulId:$that._settings.ulId,loaded:$that._options.retrieved})}a("#"+$that._settings.progressDivId).hide(250,function(){$that._widgetState.busy=false})},error:function(b){$that._trigger("error",{type:"lazyloadererror","function":"_load",message:b,settings:$that._settings,options:$that._options,parameters:$that._parameters});a("#"+$that._settings.progressDivId).hide(250,
function(){$that._widgetState.busy=false})}})})},b))},_handleMouseWheelEvent:function(){if(!this._mouseWheelEventJustFired&&!this._handleScrollStopJustFired&&!this._handleScrollStartJustFired){this._mouseWheelEventJustFired=!0;this._load(this.timeoutOptions.mousewheel);var b=this;this._mouseWheelTimeoutId=setTimeout(function(){b._mouseWheelEventJustFired=!1},1E3)}},_handleScrollStart:function(){if(!this._mouseWheelEventJustFired&&!this._handleScrollStopJustFired&&!this._handleScrollStartJustFired){this._handleScrollStartJustFired=
!0;this._load(this.timeoutOptions.scrollstart);var b=this;this._handleScrollStartTimeoutId=setTimeout(function(){b._handleScrollStartJustFired=!1},1200)}},_handleScrollStop:function(){if(!this._mouseWheelEventJustFired&&!this._handleScrollStopJustFired&&!this._handleScrollStartJustFired){this._handleScrollStopJustFired=!0;this._load(this.timeoutOptions.scrollstop);var b=this;this._handleScrollStopTimeoutId=setTimeout(function(){b._handleScrollStopJustFired=!1},1200)}},reInitialize:function(b,a,e){this._initialize(b,
a,e)},reset:function(b){var c=this;a.ajax({type:"POST",url:c._settings.clearUrl,async:!0,data:"section="+b,success:function(a){parseInt(a)&&(c._options.retrieved=c._defaultOptions.retrieved,c._widgetState.done=!1,"undefined"!=typeof c._instances[b]&&delete c._instances[b],c._trigger("reset",{type:"lazyloaderreset","function":"reset",pageId:b,settings:c._settings,options:c._options,parameters:c._parameters}))},error:function(b){c._trigger("error",{type:"lazyloadererror","function":"reset",message:b,
settings:c._settings,options:c._options,parameters:c._parameters});a("#"+c._settings.progressDivId).hide(250,function(){c._widgetState.busy=!1})}})},resetAll:function(){var b=this;a.ajax({type:"POST",url:b._settings.clearUrl,async:!0,data:"",success:function(a){if(parseInt(a)){for(pageId in b._instances)b._instances[pageId]&&delete b._instances[pageId];b._options.retrieved=b._defaultOptions.retrieved;b._widgetState.done=!1;b._widgetState.busy=!1;b._trigger("resetall",{type:"lazyloaderresetall","function":"resetAll",
_widgetState:b._widgetState,_instances:b._instances})}}})}});a(document).bind("pagecreate create",function(b){a.mobile.lazyloader.prototype.enhanceWithin(b.target)})})(jQuery);
